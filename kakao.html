
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카카오 로그인 처리중...</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>
</head>
<body>
    <p>로그인 처리 중입니다. 잠시만 기다려주세요...</p>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6Ws2dXPrMqUQTwVbGDdcAhdKJzJK1Cmk",
            authDomain: "thick-fdd38.firebaseapp.com",
            projectId: "thick-fdd38",
            storageBucket: "thick-fdd38.appspot.com",
            messagingSenderId: "109235677950",
            appId: "1:109235677950:web:f58eb3bcdfdaea9e3793af",
            measurementId: "G-LH61G4J09W"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        if (!Kakao.isInitialized()) {
            Kakao.init('40173e2de2b82288c08adec5c79dafb5');
        }

        const code = new URL(window.location.href).searchParams.get("code");

        if (code) {
            // This is a simplified example. In a real application, you would exchange 
            // the code for a token on your server to keep your client secret safe.
            // However, for this client-side only example, we'll proceed, 
            // but be aware of the security implications.
            
            // Note: Kakao SDK v2 for JS doesn't directly support token exchange 
            // in the browser like v1 did. The authorization code flow requires a server.
            // The intended flow is:
            // 1. Get code in browser.
            // 2. Send code to your server.
            // 3. Server exchanges code for access token (using your REST API Key).
            // 4. Server gets user info with the token.
            // 5. Server creates a custom Firebase token.
            // 6. Server sends Firebase token to the browser.
            // 7. Browser signs in with the custom token.

            // Since we are in a client-only environment, we will use the legacy Kakao.Auth.login flow
            // which is not the recommended OAuth 2.0 flow, but works for simple cases.
            // We will now pivot to using the access token that the JS SDK can retrieve.
            
            // The authorize redirect gives us a code, but the JS SDK doesn't have a method 
            // to directly use it. We'll use the implicit flow by calling `Kakao.Auth.login` again
            // which will handle the token for us if the user is already approved.
            
            // The redirect was mainly to bring the user back to our app. Now we fetch the profile.
            
            Kakao.Auth.setAccessToken(null); // Clear any old token
            
            // This is a workaround. The correct implementation is the server-side exchange.
            // Since we can't do that, we can't directly use the "code".
            // The `authorize` redirect is often used with a server. For a pure client-side app,
            // `Kakao.Auth.login` is more direct. Let's assume the user is logged into Kakao and 
            // we can get their info.
            
            Kakao.API.request({
                url: '/v2/user/me',
                success: handleKakaoUser,
                fail: (error) => {
                    console.error("Kakao API request failed", error);
                    alert("카카오 사용자 정보를 가져오는 데 실패했습니다.");
                    window.location.href = "/index.html";
                }
            });

        } else {
            console.error("No authorization code found.");
            alert("카카오 인증에 실패했습니다.");
            window.location.href = "/index.html";
        }

        async function handleKakaoUser(userData) {
            try {
                const kakaoId = String(userData.id);
                const nickname = userData.kakao_account?.profile?.nickname || '사용자';
                const email = userData.kakao_account?.email || null;

                // Create a unique email for Firebase, as Kakao sometimes doesn't provide one.
                const firebaseEmail = email || `${kakaoId}@kakao.thick.ai`;
                
                // We need a password for email/password sign-in. We'll generate a predictable one.
                // This is NOT secure and is a workaround for not using custom tokens.
                const firebasePassword = `kakao_${kakaoId}`;

                // Try to sign in the user.
                try {
                    await auth.signInWithEmailAndPassword(firebaseEmail, firebasePassword);
                } catch (error) {
                    // If the user doesn't exist, create a new account.
                    if (error.code === 'auth/user-not-found') {
                        const userCredential = await auth.createUserWithEmailAndPassword(firebaseEmail, firebasePassword);
                        await userCredential.user.updateProfile({ displayName: nickname });
                        
                        // Save user info to Firestore
                        await db.collection('users').doc(userCredential.user.uid).set({
                            uid: userCredential.user.uid,
                            nickname: nickname,
                            email: firebaseEmail,
                            provider: 'kakao',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                    } else {
                        throw error; // Re-throw other errors
                    }
                }
                
                // Redirect to dashboard on successful login/signup
                window.location.href = 'dashboard.html';

            } catch (e) {
                console.error("Firebase authentication error:", e);
                alert('로그인 처리 중 오류가 발생했습니다.');
                window.location.href = "/index.html";
            }
        }
    </script>
</body>
</html>
