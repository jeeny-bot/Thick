
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카카오 로그인 처리 중...</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.6.0/kakao.min.js"></script>
</head>
<body>
    <p>로그인 처리 중입니다. 잠시만 기다려주세요...</p>

    <script>
        // 1. Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB6Ws2dXPrMqUQTwVbGDdcAhdKJzJK1Cmk",
            authDomain: "thick-fdd38.firebaseapp.com",
            projectId: "thick-fdd38",
            storageBucket: "thick-fdd38.appspot.com",
            messagingSenderId: "109235677950",
            appId: "1:109235677950:web:f58eb3bcdfdaea9e3793af",
            measurementId: "G-LH61G4J09W"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. Initialize Kakao SDK
        Kakao.init('40173e2de2b82288c08adec5c79dafb5'); // JAVASCRIPT KEY

        // 3. Main Logic
        (async () => {
            const code = new URL(window.location.href).searchParams.get("code");
            if (!code) {
                alert('인증 코드가 없습니다. 로그인 페이지로 돌아갑니다.');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // Exchange authorization code for access token
                const tokenResponse = await fetch('https://kauth.kakao.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8' },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: '40173e2de2b82288c08adec5c79dafb5', // This should be your REST API key
                        redirect_uri: `${window.location.origin}/kakao.html`,
                        code: code,
                    })
                });
                const tokenData = await tokenResponse.json();

                if (tokenData.error) {
                    throw new Error(tokenData.error_description || '카카오 토큰 발급에 실패했습니다.');
                }

                Kakao.Auth.setAccessToken(tokenData.access_token);
                
                const userData = await Kakao.API.request({ url: '/v2/user/me' });

                const kakaoId = userData && userData.id ? String(userData.id) : null;
                if (!kakaoId) {
                    throw new Error('카카오 사용자 ID를 가져오지 못했습니다.');
                }

                const nickname = userData.kakao_account?.profile?.nickname || '사용자';
                const email = userData.kakao_account?.email;

                const firebaseEmail = email || `${kakaoId}@kakao.thick.ai`;
                const firebasePassword = `kakao_${kakaoId}`;

                // --- Added for Debugging ---
                console.log("Attempting Firebase auth with:");
                console.log("Email:", firebaseEmail);
                console.log("Password:", firebasePassword);

                try {
                    await auth.signInWithEmailAndPassword(firebaseEmail, firebasePassword);
                } catch (error) {
                    if (error.code === 'auth/user-not-found') {
                        const userCredential = await auth.createUserWithEmailAndPassword(firebaseEmail, firebasePassword);
                        await userCredential.user.updateProfile({ displayName: nickname });

                        await db.collection('users').doc(userCredential.user.uid).set({
                            uid: userCredential.user.uid,
                            nickname: nickname,
                            email: firebaseEmail,
                            provider: 'kakao',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    } else {
                        const specificError = new Error(`Firebase 로그인 실패: ${error.message} (코드: ${error.code})`);
                        specificError.original = error;
                        throw specificError;
                    }
                }

                window.location.href = 'dashboard.html';

            } catch (error) {
                console.error("Kakao login or Firebase auth error:", error);
                alert(error.message || "카카오 로그인 중 알 수 없는 오류가 발생했습니다.");
                window.location.href = 'index.html';
            }
        })();
    </script>
</body>
</html>
