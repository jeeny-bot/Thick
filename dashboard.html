<script>
    // CRITICAL: Force-unregister and reload to fix persistent service worker issues on iOS.
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            if (registrations.length > 0) {
                console.log('Found active service workers, unregistering and reloading...');
                let unregisterPromises = registrations.map(registration => registration.unregister());
                Promise.all(unregisterPromises).then(() => {
                    // Force a hard reload from the network, bypassing the cache.
                    window.location.reload(true);
                });
            }
        }).catch(function(err) {
            console.error('Service Worker unregistration failed: ', err);
        });
    }
</script>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thick - Dashboard</title>

<style>
  :root {
  --orange-main: #e67e22;
  --orange-light: #ff9f43;
}
  
body {
  margin: 0;
  background: linear-gradient(160deg, #0f0f0f 0%, #1c1c1e 100%);
  font-family: 'Noto Sans KR', sans-serif;
  color: #fff;
}

.wrapper {
  min-height: 100vh;
  padding: 100px 24px 60px 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.header {
  text-align: center;
  margin-bottom: 60px;
}

.main-title {
  font-size: 2rem;
  font-weight: 900;
  margin-bottom: 12px;
}


.sub-title {
  font-size: 0.95rem;
  color: rgba(255,255,255,0.6);
}


.menu-container {
  width: 100%;
  max-width: 380px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.menu-card {
  padding: 28px;
  border-radius: 28px;
  cursor: pointer;
  transition: 0.25s ease;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.menu-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 25px 60px rgba(0,0,0,0.6);
}

.card-report {
  background: #f8f8f8;
  color: #000;
}

.card-scan {
  background: linear-gradient(135deg, var(--orange-main), var(--orange-light));
  color: #fff;
}

.card-title {
  font-size: 1.3rem;
  font-weight: 900;
  margin-bottom: 8px;
}

.card-desc {
  font-size: 0.85rem;
  opacity: 0.7;
}

#user-status-bar {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  padding: 10px 18px;
  border-radius: 30px;
  font-weight: 700;
  font-size: 0.8rem;
  border: 1px solid rgba(255,255,255,0.1);
}

#logout-btn {
  background: linear-gradient(135deg, #e67e22, #ff9f43);
  border: none;
  color: #fff;
  padding: 8px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 700;
  box-shadow: 0 8px 20px rgba(230,126,34,0.4);

}




#logout-btn:hover {
  transform: scale(1.1);
}

 .menu-card {
  padding: 22px 20px;
}

.card-row {
  display: flex;
  align-items: center;
  gap: 18px;
}

.card-icon {
  font-size: 2rem;
  min-width: 44px;
}

.card-text {
  flex: 1;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 900;
  margin-bottom: 6px;
}

.card-desc {
  font-size: 0.85rem;
  opacity: 0.7;
}
 
.title-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
}

.title-logo {
  width: 35px;
  height: 35px;
  object-fit: contain;
}
.title-row .hero-logo {
  width: 36px;
  height: 36px;
  border: 3px solid #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 0.8rem;
}

#rebuy-container {
    background: #2c2c2e;
    border-radius: 28px;
    padding: 22px;
}

#rebuy-container h3 {
    margin-top: 0;
    font-size: 1.1rem;
    line-height: 1.5;
    color: var(--orange-light);
}

.rebuy-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.rebuy-item:last-child {
    border-bottom: none;
}

.rebuy-item-name {
    font-weight: 700;
}

.rebuy-item-details {
    font-size: 0.8rem;
    color: #bbb;
}

</style>
<!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TZ5LFV948V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TZ5LFV948V');
    </script>
<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vix7j595ui");
</script>
</head>

<body>

<div id="user-status-bar">
  <span id="status-text">ë¡œë”©ì¤‘...</span>
  <button id="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>


</div>


<div class="wrapper">

 <div class="header">
  <div class="title-row">
    <div class="hero-logo">III</div>
    <div class="main-title">ì´ë²ˆ ë‹¬ ì†Œë¹„ë¥¼ í•œëˆˆì—</div>
  </div>
  <div class="sub-title">ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë˜‘ë˜‘í•œ ì†Œë¹„ë¥¼ ì‹œì‘í•˜ì„¸ìš”</div>
</div>

  <div class="menu-container">

    <div id="rebuy-container">
      <h3>íšŒì›ë‹˜ì´ ì§€ë‚œ í•œë‹¬ë™ì•ˆ<br>ë‘ë²ˆ ì´ìƒ êµ¬ë§¤í•œ ë‚´ì—­ì…ë‹ˆë‹¤</h3>
      <div id="rebuy-list">
        <p>êµ¬ë§¤ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    </div>

    <div class="menu-card card-report" onclick="goReport()">
      <div class="card-row">
        <div class="card-icon">ğŸ“Š</div>
        <div class="card-text">
          <div class="card-title">ì†Œë¹„ ë¦¬í¬íŠ¸ í™•ì¸</div>
          <div class="card-desc">ì´ë²ˆ ë‹¬ ì†Œë¹„ ë¶„ì„ê³¼ 3ê°œì›” ì¶”ì´ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
        </div>
      </div>
    </div>


    <div class="menu-card card-scan" onclick="goScan()">
      <div class="card-row">
        <div class="card-icon">ğŸ›’</div>
        <div class="card-text">
          <div class="card-title">ì§€ê¸ˆ ì¥ë³´ê¸° ì‹œì‘</div>
          <div class="card-desc">ë§ˆíŠ¸ì—ì„œ ìƒí’ˆì„ ìŠ¤ìº”í•˜ê³  ì†Œë¹„ë¥¼ ê¸°ë¡í•˜ì„¸ìš”</div>
        </div>
      </div>
    </div>

  </div>

</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore,
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  Timestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


const firebaseConfig = {
  apiKey: "AIzaSyB6Ws2dXPrMqUQTwVbGDdcAhdKJzJK1Cmk",
  authDomain: "thick-fdd38.firebaseapp.com",
  projectId: "thick-fdd38",
  storageBucket: "thick-fdd38.firebasestorage.app",
  messagingSenderId: "109235677950",
  appId: "1:109235677950:web:f58eb3bcdfdaea9e3793af",
  measurementId: "G-LH61G4J09W"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const snapshot = await getDoc(userRef);

  const data = snapshot.data();
  const statusBar = document.getElementById("status-text");



  if (!data) {
    statusBar.innerText = "íšŒì›ì •ë³´ ì—†ìŒ";
    return;
  }

  if (data.subscriptionStatus === "active") {
    statusBar.innerText = "êµ¬ë…ì¤‘";
  } else if (data.subscriptionStatus === "trial") {
    const createdAt = data.createdAt.toDate();
    const now = new Date();
    const totalTrialHours = 60 * 24;
    const diffHours = Math.floor((now - createdAt) / (1000 * 60 * 60));
    const remainHours = totalTrialHours - diffHours;
    if (remainHours > 0) {
      const days = Math.floor(remainHours / 24);
      const hours = remainHours % 24;
      statusBar.innerText = `ë¬´ë£Œì‚¬ìš©ì¤‘ - ${days}ì¼ ${hours}ì‹œê°„`;
    } else {
      statusBar.innerText = "ë¬´ë£Œê¸°ê°„ ì¢…ë£Œ";
    }
  } else {
      const createdAt = data.createdAt.toDate();
      const now = new Date();
      const diffDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
      const remain = 60 - diffDays;
      if (remain > 0) {
        statusBar.innerText = `ë¬´ë£Œì‚¬ìš©ì¤‘ - ${remain}ì¼`;
      } else {
        statusBar.innerText = "ë¬´ë£Œê¸°ê°„ ì¢…ë£Œ";
      }
  }

  //-- Start Frequent Purchase Analysis --//
  analyzeFrequentPurchases(user);

});

async function analyzeFrequentPurchases(user) {
    // 1. Set the timeframe to the last 30 days
    const oneMonthAgo = new Date();
    oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);

    const sessionsRef = collection(db, "users", user.uid, "sessions");
    const q = query(sessionsRef, where("createdAt", ">=", Timestamp.fromDate(oneMonthAgo)));

    const snapshot = await getDocs(q);
    
    // 2. Count purchase frequency for each item across different sessions
    const itemPurchaseEvents = {}; 

    snapshot.forEach(doc => {
        const session = doc.data();
        if (session.items) {
            // Use a Set to count an item only once per session
            const distinctItemsInSession = new Set(session.items.map(item => item.name));
            
            distinctItemsInSession.forEach(itemName => {
                const item = session.items.find(i => i.name === itemName);

                if (!itemPurchaseEvents[itemName]) {
                    itemPurchaseEvents[itemName] = { dates: [], lastPrice: 0 };
                }
                itemPurchaseEvents[itemName].dates.push(session.createdAt.toDate());
                itemPurchaseEvents[itemName].lastPrice = item.price;
            });
        }
    });

    // 3. Filter for items purchased 2 or more times
    const frequentItems = [];
    for (const itemName in itemPurchaseEvents) {
        if (itemPurchaseEvents[itemName].dates.length >= 2) {
            frequentItems.push({
                name: itemName,
                count: itemPurchaseEvents[itemName].dates.length,
                lastPrice: itemPurchaseEvents[itemName].lastPrice
            });
        }
    }

    // 4. Display the results
    const listContainer = document.getElementById('rebuy-list');
    listContainer.innerHTML = '';

    if (frequentItems.length === 0) {
        listContainer.innerHTML = '<p style="font-size:0.9rem; color:#ccc; text-align:center;">ì§€ë‚œ í•œ ë‹¬ ë™ì•ˆ 2íšŒ ì´ìƒ<br>êµ¬ë§¤í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }

    // Sort by most frequently purchased
    frequentItems.sort((a, b) => b.count - a.count);

    frequentItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'rebuy-item';

        const nameSpan = document.createElement('span');
        nameSpan.className = 'rebuy-item-name';
        nameSpan.innerText = item.name;

        const detailsSpan = document.createElement('span');
        detailsSpan.className = 'rebuy-item-details';
        detailsSpan.innerText = `ì´ ${item.count}íšŒ êµ¬ë§¤ / ìµœê·¼ ${item.lastPrice.toLocaleString()}ì›`;

        itemDiv.appendChild(nameSpan);
        itemDiv.appendChild(detailsSpan);
        listContainer.appendChild(itemDiv);
    });
}

window.goReport = function() {
  window.location.href = "report.html";
};

window.goScan = function() {
  window.location.href = "scan.html";
};

window.window.logout = async function() {
  await signOut(auth);
  window.location.href = "index.html";
};


</script>

</body>
</html>
