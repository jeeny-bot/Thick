<script>
    // CRITICAL: Force-unregister and reload to fix persistent service worker issues on iOS.
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            if (registrations.length > 0) {
                console.log('Found active service workers, unregistering and reloading...');
                let unregisterPromises = registrations.map(registration => registration.unregister());
                Promise.all(unregisterPromises).then(() => {
                    // Force a hard reload from the network, bypassing the cache.
                    window.location.reload(true);
                });
            }
        }).catch(function(err) {
            console.error('Service Worker unregistration failed: ', err);
        });
    }
</script>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>내 데이터보기</title>

<style>
body {
  margin: 0;
  font-family: 'Noto Sans KR', sans-serif;
  background: linear-gradient(160deg, #0f0f0f 0%, #1c1c1e 100%);
  color: #fff;
}

.wrapper {
  padding: 80px 20px 60px 20px;
  max-width: 540px;
  margin: auto;
}

.title {
  font-size: 1.9rem;
  font-weight: 900;
  margin-bottom: 35px;
  text-align: center;
}

.hero-card {
  background: linear-gradient(135deg, #e67e22, #ff9f43);
  border-radius: 28px;
  padding: 35px 25px;
  margin-bottom: 35px;
  box-shadow: 0 25px 60px rgba(230,126,34,0.35);
  transition: transform 0.2s ease;
}

.hero-card h3 {
  margin: 0 0 15px 0;
  font-size: 1rem;
  font-weight: 600;
  opacity: 0.9;
}

.hero-value {
  font-size: 2.4rem;
  font-weight: 900;
}

.card {
  background: #ffffff;
  color: #000;
  border-radius: 22px;
  padding: 22px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  transition: transform 0.2s ease;
  margin-bottom: 18px;
}

.card:hover {
  transform: translateY(-4px);
}

.card h3 {
  margin: 0 0 12px 0;
  font-size: 0.8rem;
  font-weight: 700;
  opacity: 0.6;
}

.big-number {
  font-size: 1.3rem;
  font-weight: 900;
  color: #e67e22;
}

button {
  transition: 0.2s ease;
}
button:hover {
  opacity: 0.8;
}
.exit-btn {
  position: fixed;
  top: 30px;
  left: 20px;
  padding: 16px 30px;
  border: none;
  border-radius: 40px;
  background: #e67e22;
  color: #fff;
  font-size: 1.1rem;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 30px rgba(230,126,34,0.45);
  z-index: 9999;
  transition: 0.2s ease;
}

.exit-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 18px 40px rgba(230,126,34,0.55);
}
.clickable {
  cursor: pointer;
}

.chart-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.chart-box {
  background: linear-gradient(145deg, #1e1e22, #111113);
  width: 90%;
  max-width: 480px;
  padding: 35px;
  border-radius: 28px;
  position: relative;
  box-shadow: 0 30px 60px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,255,255,0.05);
}


.chart-close {
  position: absolute;
  top: 18px;
  right: 18px;
  border: none;
  background: #ff8c2a;
  color: #fff;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(255,140,42,0.5);
}

.hidden {
  display: none;
}

.modal-title {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 25px;
  text-align: center;
  color: #fff;
}
.consumption-list {
  max-height: 400px;
  overflow-y: auto;
  padding-right: 10px;
}
.consumption-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 10px;
  background: rgba(255,255,255,0.03);
  border-radius: 12px;
  margin-bottom: 10px;
}

.consumption-item.session {
  cursor: pointer;
  transition: background-color 0.2s ease;
}
.consumption-item.session:hover {
  background: rgba(255,255,255,0.08);
}

.consumption-date {
  font-weight: 600;
  color: #eee;
}
.consumption-price {
  font-weight: 700;
  color: #ff9f43;
}

.item-details {
  flex-grow: 1;
  margin-right: 10px;
}

.item-name {
  font-weight: 600;
  color: #eee;
  margin-bottom: 4px;
}

.item-calculation {
  font-size: 0.85rem;
  color: #bbb;
}

.item-total-price {
  font-weight: 700;
  color: #ff9f43;
  flex-shrink: 0;
  font-size: 1.1rem;
}

</style>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

 <button onclick="goDashboard()" class="exit-btn">
  ← 나가기
</button>

<div class="wrapper">

<div class="title">이번 달 소비 리포트</div>

<div class="hero-card clickable" onclick="openMonthlySessionsModal()">
  <h3>이번 달 총 소비</h3>
  <div class="hero-value" id="month-total">로딩중...</div>
</div>


  <div class="card clickable" onclick="openChartModal('diff')">
    <h3>지난달 대비 변화</h3>
    <div class="big-number" id="month-diff">로딩중...</div>
  </div>

  <div class="card clickable" onclick="openChartModal('count')">
    <h3>이번 달 구매 횟수</h3>
    <div class="big-number" id="month-count">로딩중...</div>
  </div>

  <div class="card clickable" onclick="openChartModal('average')">
    <h3>평균 장보기 금액</h3>
    <div class="big-number" id="month-average">로딩중...</div>
  </div>

</div>

<script type="module">

const firebaseConfig = {
    apiKey: "AIzaSyB6Ws2dXPrMqUQTwVbGDdcAhdKJzJK1Cmk",
    authDomain: "thick-fdd38.firebaseapp.com",
    projectId: "thick-fdd38",
    storageBucket: "thick-fdd38.firebasestorage.app",
    messagingSenderId: "109235677950",
    appId: "1:109235677950:web:f58eb3bcdfdaea9e3793af",
    measurementId: "G-LH61G4J09W"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let monthSessions = [];

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastMonthFirstDay = new Date(
    now.getFullYear(),
    now.getMonth() - 1,
    1
  );
  const lastMonthLastDay = new Date(
    now.getFullYear(),
    now.getMonth(),
    0,
    23, 59, 59
  );

  const sessionsRef = collection(db, "users", user.uid, "sessions");

  const q = query(
    sessionsRef,
    where("createdAt", ">=", firstDay)
  );
  const lastMonthQuery = query(
    sessionsRef,
    where("createdAt", ">=", lastMonthFirstDay),
    where("createdAt", "<=", lastMonthLastDay)
  );

  const snapshot = await getDocs(q);

  let total = 0;
  let count = 0;
  monthSessions = []; 

  snapshot.forEach(doc => {
    const data = doc.data();
    total += data.totalPrice || 0;
    count++;
    monthSessions.push(data);
  });

  const lastSnapshot = await getDocs(lastMonthQuery);
  let lastTotal = 0;
  lastSnapshot.forEach(doc => {
    lastTotal += doc.data().totalPrice || 0;
  });

  document.getElementById("month-total").innerText = total.toLocaleString() + "원";
  
  let diff = total - lastTotal;
  let diffText = "";

  if (diff > 0) {
    diffText = `+${diff.toLocaleString()}원 증가`;
  } else if (diff < 0) {
    diffText = `${diff.toLocaleString()}원 절약`;
  } else {
    diffText = "변화 없음";
  }
  document.getElementById("month-diff").innerText = diffText;

  document.getElementById("month-count").innerText = count + "회";
  
  let average = 0;
  if (count > 0) {
    average = Math.floor(total / count);
  }
  document.getElementById("month-average").innerText = average.toLocaleString() + "원";
});

window.goDashboard = function() {
  window.location.href = "dashboard.html";
};

let chartInstance = null;

window.openChartModal = async function(type) {

  const modal = document.getElementById("chart-modal");
  modal.classList.remove("hidden");

  const ctx = document.getElementById("chartCanvas");

  if (chartInstance) {
    chartInstance.destroy();
  }

  const user = auth.currentUser;
  if (!user) return;

  const now = new Date();
  const months = [];
  const values = [];

  const sessionsRef = collection(db, "users", user.uid, "sessions");

  for (let i = 2; i >= 0; i--) {

    const start = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const end = new Date(now.getFullYear(), now.getMonth() - i + 1, 0, 23, 59, 59);

    months.push(start.getMonth() + 1 + "월");

    const q = query(
      sessionsRef,
      where("createdAt", ">=", start),
      where("createdAt", "<=", end)
    );

    const snapshot = await getDocs(q);

    let total = 0;
    let count = 0;

    snapshot.forEach(doc => {
      const data = doc.data();
      total += data.totalPrice || 0;
      count++;
    });

    if (type === "count") {
      values.push(count);
    } else if (type === "average") {
      values.push(count > 0 ? Math.floor(total / count) : 0);
    } else {
      values.push(total);
    }
  }

  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        data: values,
        backgroundColor: '#ff8c2a',
        borderRadius: 12,
        barThickness: 40
      }]
    },
    options: {
      responsive: true,
      animation: {
        duration: 900,
        easing: 'easeOutCubic'
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: "rgba(255,255,255,0.08)"
          },
          ticks: {
            color: "#999"
          }
        },
        x: {
          grid: { display: false },
          ticks: {
            color: "#999",
            font: { weight: '700' }
          }
        }
      },
      plugins: {
        legend: { display: false }
      }
    }
  });
};

window.closeChartModal = function() {
  document.getElementById("chart-modal").classList.add("hidden");
};

window.openMonthlySessionsModal = function() {
  const modal = document.getElementById("monthly-sessions-modal");
  modal.classList.remove("hidden");

  const listContainer = document.getElementById("monthly-sessions-list");
  listContainer.innerHTML = ''; 

  if (monthSessions.length === 0) {
    listContainer.innerHTML = '<p style="text-align:center;color:#ccc;">이번 달 구매 내역이 없습니다.</p>';
    return;
  }
  
  const sortedSessions = [...monthSessions].sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

  sortedSessions.forEach((session, index) => {
    const sessionDiv = document.createElement('div');
    sessionDiv.className = 'consumption-item session';
    
    const originalIndex = monthSessions.indexOf(session);
    sessionDiv.onclick = () => openSessionDetailsModal(originalIndex);

    const dateSpan = document.createElement('span');
    dateSpan.className = 'consumption-date';
    dateSpan.innerText = session.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });

    const priceSpan = document.createElement('span');
    priceSpan.className = 'consumption-price';
    priceSpan.innerText = (session.totalPrice || 0).toLocaleString() + '원';
    
    const arrowSpan = document.createElement('span');
    arrowSpan.innerText = '›';
    arrowSpan.style.color = '#ccc';
    arrowSpan.style.fontWeight = 'bold';

    sessionDiv.appendChild(dateSpan);
    sessionDiv.appendChild(priceSpan);
    sessionDiv.appendChild(arrowSpan);
    listContainer.appendChild(sessionDiv);
  });
};

window.closeMonthlySessionsModal = function() {
  document.getElementById("monthly-sessions-modal").classList.add("hidden");
};

window.openSessionDetailsModal = function(sessionIndex) {
  const session = monthSessions[sessionIndex];
  if (!session) return;

  const modal = document.getElementById("session-details-modal");
  modal.classList.remove("hidden");

  const title = document.getElementById("session-details-title");
  title.innerText = `${session.createdAt.toDate().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })} 구매 내역`;

  const listContainer = document.getElementById("session-details-list");
  listContainer.innerHTML = ''; 

  if (!session.items || session.items.length === 0) {
    listContainer.innerHTML = '<p style="text-align:center;color:#ccc;">해당 일자의 구매 상품이 없습니다.</p>';
    return;
  }

  session.items.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'consumption-item';

    const detailsDiv = document.createElement('div');
    detailsDiv.className = 'item-details';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'item-name';
    nameDiv.innerText = item.name;

    const calculationDiv = document.createElement('div');
    calculationDiv.className = 'item-calculation';
    calculationDiv.innerText = `${item.price.toLocaleString()}원 x ${item.qty}`;
    
    detailsDiv.appendChild(nameDiv);
    detailsDiv.appendChild(calculationDiv);

    const totalPriceSpan = document.createElement('span');
    totalPriceSpan.className = 'item-total-price';
    totalPriceSpan.innerText = (item.price * item.qty).toLocaleString() + '원';

    itemDiv.appendChild(detailsDiv);
    itemDiv.appendChild(totalPriceSpan);
    listContainer.appendChild(itemDiv);
  });
};

window.closeSessionDetailsModal = function() {
  document.getElementById("session-details-modal").classList.add("hidden");
};

</script>

<!-- Chart Modal -->
<div id="chart-modal" class="chart-modal hidden">
  <div class="chart-box">
    <button class="chart-close" onclick="closeChartModal()">✕</button>
    <canvas id="chartCanvas"></canvas>
  </div>
</div>

<!-- Monthly Sessions Modal -->
<div id="monthly-sessions-modal" class="chart-modal hidden">
  <div class="chart-box">
    <button class="chart-close" onclick="closeMonthlySessionsModal()">✕</button>
    <h3 class="modal-title">이번 달 구매 내역 (일자별)</h3>
    <div id="monthly-sessions-list" class="consumption-list">
      <!-- Daily session data will be injected here -->
    </div>
  </div>
</div>

<!-- Session Details Modal -->
<div id="session-details-modal" class="chart-modal hidden">
  <div class="chart-box">
    <button class="chart-close" onclick="closeSessionDetailsModal()">✕</button>
    <h3 class="modal-title" id="session-details-title"></h3>
    <div id="session-details-list" class="consumption-list">
      <!-- Item data for a session will be injected here -->
    </div>
  </div>
</div>

</body>
</html>
